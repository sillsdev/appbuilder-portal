generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuidOssp(map: "uuid-ossp")]
}

model ApplicationTypes {
  Id                 Int                  @id(map: "PK_ApplicationTypes") @default(autoincrement())
  Name               String?
  Description        String?
  ProjectImports     ProjectImports[]
  Projects           Projects[]
  SystemVersions     SystemVersions[]
  SoftwareUpdates    SoftwareUpdates[]
}

model Authors {
  // ISSUE: #1102 composite keys?
  Id        Int      @id(map: "PK_Authors") @default(autoincrement())
  UserId    Int
  ProjectId Int
  CanUpdate Boolean?
  Project   Projects @relation(fields: [ProjectId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Authors_Projects_ProjectId")
  User      Users    @relation(fields: [UserId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Authors_Users_UserId")

  @@index([ProjectId], map: "IX_Authors_ProjectId")
  @@index([UserId], map: "IX_Authors_UserId")
}

model GroupMemberships {
  // ISSUE: #1102 composite keys?
  Id      Int    @id(map: "PK_GroupMemberships") @default(autoincrement())
  UserId  Int
  GroupId Int
  Group   Groups @relation(fields: [GroupId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_GroupMemberships_Groups_GroupId")
  User    Users  @relation(fields: [UserId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_GroupMemberships_Users_UserId")

  @@index([GroupId], map: "IX_GroupMemberships_GroupId")
  @@index([UserId], map: "IX_GroupMemberships_UserId")
}

model Groups {
  Id               Int                @id(map: "PK_Groups") @default(autoincrement())
  Name             String?
  Abbreviation     String?
  OwnerId          Int
  GroupMemberships GroupMemberships[]
  Owner            Organizations      @relation(fields: [OwnerId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Groups_Organizations_OwnerId")
  ProjectImports   ProjectImports[]
  Projects         Projects[]

  @@index([OwnerId], map: "IX_Groups_OwnerId")
}

model OrganizationMembershipInvites {
  // ISSUE: #1102 composite keys?
  Id             Int           @id(map: "PK_OrganizationMembershipInvites") @default(autoincrement())
  Token          String        @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  Email          String
  Expires        DateTime      @default(dbgenerated("(CURRENT_DATE + 7)")) @db.Timestamp(6)
  Redeemed       Boolean       @default(false)
  InvitedById    Int
  OrganizationId Int
  Roles          Int[]         @default([])
  Groups         Int[]         @default([])
  DateCreated    DateTime?     @default(now()) @db.Timestamp(6)
  DateUpdated    DateTime?     @updatedAt @db.Timestamp(6)
  Organization   Organizations @relation(fields: [OrganizationId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationMembershipInvites_Organizations_OrganizationId")
  InvitedBy      Users         @relation(fields: [InvitedById], references: [Id], onDelete: NoAction, onUpdate: NoAction, map: "FK_OrganizationMembershipInvites_Users_InvitedById")

  @@index([InvitedById], map: "IX_OrganizationMembershipInvites_InvitedById")
  @@index([OrganizationId], map: "IX_OrganizationMembershipInvites_OrganizationId")
}

model OrganizationMemberships {
  // ISSUE: #1102 composite keys?
  Id             Int           @id(map: "PK_OrganizationMemberships") @default(autoincrement())
  UserId         Int
  OrganizationId Int
  Organization   Organizations @relation(fields: [OrganizationId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationMemberships_Organizations_OrganizationId")
  User           Users         @relation(fields: [UserId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationMemberships_Users_UserId")

  @@index([OrganizationId], map: "IX_OrganizationMemberships_OrganizationId")
  @@index([UserId], map: "IX_OrganizationMemberships_UserId")
}

model OrganizationProductDefinitions {
  Id                  Int                @id(map: "PK_OrganizationProductDefinitions") @default(autoincrement())
  OrganizationId      Int
  ProductDefinitionId Int
  Organization        Organizations      @relation(fields: [OrganizationId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationProductDefinitions_Organizations_OrganizationId")
  ProductDefinition   ProductDefinitions @relation(fields: [ProductDefinitionId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationProductDefinitions_ProductDefinitions_ProductDe~")

  @@index([OrganizationId], map: "IX_OrganizationProductDefinitions_OrganizationId")
  @@index([ProductDefinitionId], map: "IX_OrganizationProductDefinitions_ProductDefinitionId")
}

model OrganizationStores {
  // ISSUE: #1102 composite keys?
  Id             Int           @id(map: "PK_OrganizationStores") @default(autoincrement())
  OrganizationId Int
  StoreId        Int
  Organization   Organizations @relation(fields: [OrganizationId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationStores_Organizations_OrganizationId")
  Store          Stores        @relation(fields: [StoreId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_OrganizationStores_Stores_StoreId")

  @@index([OrganizationId], map: "IX_OrganizationStores_OrganizationId")
  @@index([StoreId], map: "IX_OrganizationStores_StoreId")
}

model Organizations {
  Id                             Int                              @id(map: "PK_Organizations") @default(autoincrement())
  Name                           String?
  WebsiteUrl                     String?
  BuildEngineUrl                 String?
  BuildEngineApiAccessToken      String?
  LogoUrl                        String?
  UseDefaultBuildEngine          Boolean?                         @default(true)
  PublicByDefault                Boolean?                         @default(true)
  ContactEmail                   String?
  Groups                         Groups[]
  OrganizationMembershipInvites  OrganizationMembershipInvites[]
  OrganizationMemberships        OrganizationMemberships[]
  OrganizationProductDefinitions OrganizationProductDefinitions[]
  ProjectImports                 ProjectImports[]
  Projects                       Projects[]
  UserRoles                      UserRoles[]
  OrganizationStores             OrganizationStores[]
}

model ProductArtifacts {
  // ISSUE: #1102 composite keys?
  Id             Int           @id(map: "PK_ProductArtifacts") @default(autoincrement())
  ProductId      String        @db.Uuid
  ProductBuildId Int
  ArtifactType   String?
  Url            String?
  FileSize       BigInt?
  ContentType    String?
  DateCreated    DateTime?     @default(now()) @db.Timestamp(6)
  DateUpdated    DateTime?     @updatedAt @db.Timestamp(6)
  ProductBuild   ProductBuilds @relation(fields: [ProductBuildId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductArtifacts_ProductBuilds_ProductBuildId")
  Product        Products      @relation(fields: [ProductId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductArtifacts_Products_ProductId")

  @@index([ProductBuildId], map: "IX_ProductArtifacts_ProductBuildId")
  @@index([ProductId], map: "IX_ProductArtifacts_ProductId")
}

model ProductBuilds {
  Id                  Int                   @id(map: "PK_ProductBuilds") @default(autoincrement())
  ProductId           String                @db.Uuid
  BuildId             Int
  Version             String?
  DateCreated         DateTime?             @default(now()) @db.Timestamp(6)
  DateUpdated         DateTime?             @updatedAt @db.Timestamp(6)
  Success             Boolean?
  AppBuilderVersion   String?
  ProductArtifacts    ProductArtifacts[]
  Product             Products              @relation(fields: [ProductId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductBuilds_Products_ProductId")
  ProductPublications ProductPublications[]
  // ISSUE: #1102 Usually a build shouldn't have multiple publications?
  // Typically, a failed publish will go to Synchronize Data, which will always build before trying to publish
  // The only edge case would be if a SuperAdmin bypasses that by jumping the workflow state...

  @@index([ProductId], map: "IX_ProductBuilds_ProductId")
}

model ProductDefinitions {
  Id                             Int                              @id(map: "PK_ProductDefinitions") @default(autoincrement())
  Name                           String?
  Description                    String?
  WorkflowId                     Int
  RebuildWorkflowId              Int?
  RepublishWorkflowId            Int?
  Properties                     String?
  OrganizationProductDefinitions OrganizationProductDefinitions[]
  RebuildWorkflow                WorkflowDefinitions?             @relation("ProductDefinitions_RebuildWorkflowIdToWorkflowDefinitions", fields: [RebuildWorkflowId], references: [Id], onDelete: Restrict, onUpdate: NoAction, map: "FK_ProductDefinitions_WorkflowDefinitions_RebuildWorkflowId")
  RepublishWorkflow              WorkflowDefinitions?             @relation("ProductDefinitions_RepublishWorkflowIdToWorkflowDefinitions", fields: [RepublishWorkflowId], references: [Id], onDelete: Restrict, onUpdate: NoAction, map: "FK_ProductDefinitions_WorkflowDefinitions_RepublishWorkflowId")
  Workflow                       WorkflowDefinitions              @relation("ProductDefinitions_WorkflowIdToWorkflowDefinitions", fields: [WorkflowId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductDefinitions_WorkflowDefinitions_WorkflowId")
  Products                       Products[]

  @@index([RebuildWorkflowId], map: "IX_ProductDefinitions_RebuildWorkflowId")
  @@index([RepublishWorkflowId], map: "IX_ProductDefinitions_RepublishWorkflowId")
  @@index([WorkflowId], map: "IX_ProductDefinitions_WorkflowId")
}

model ProductPublications {
  // ISSUE: #1102 composite keys? see comment in ProductBuilds
  Id             Int           @id(map: "PK_ProductPublications") @default(autoincrement())
  ProductId      String        @db.Uuid
  ProductBuildId Int
  ReleaseId      Int
  Channel        String?
  LogUrl         String?
  Success        Boolean?
  DateCreated    DateTime?     @default(now()) @db.Timestamp(6)
  DateUpdated    DateTime?     @updatedAt @db.Timestamp(6)
  Package        String?
  DateResolved   DateTime?     @db.Timestamp(6)
  ProductBuild   ProductBuilds @relation(fields: [ProductBuildId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductPublications_ProductBuilds_ProductBuildId")
  Product        Products      @relation(fields: [ProductId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductPublications_Products_ProductId")

  @@index([Package], map: "IX_ProductPublications_Package")
  @@index([ProductBuildId], map: "IX_ProductPublications_ProductBuildId")
  @@index([ProductId], map: "IX_ProductPublications_ProductId")
}

model ProductTransitions {
  Id               Int            @id(map: "PK_ProductTransitions") @default(autoincrement())
  ProductId        String         @db.Uuid
  // Since users are never deleted, only locked, this should be fine
  UserId           Int?
  AllowedUserNames String?
  InitialState     String?
  DestinationState String?
  Command          String?
  DateTransition   DateTime?      @db.Timestamp(6)
  Comment          String?
  TransitionType   Int            @default(1)
  WorkflowType     Int?
  Product          Products       @relation(fields: [ProductId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ProductTransitions_Products_ProductId")
  User             Users?         @relation(fields: [UserId], references: [Id])
  QueueRecords     QueueRecords[]

  @@index([ProductId], map: "IX_ProductTransitions_ProductId")
}

model QueueRecords {
  ProductTransitionId Int
  Queue               String
  JobType             String
  JobId               String
  ProductTransition ProductTransitions @relation(fields: [ProductTransitionId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_QueueRecords_ProductTransitions_ProductTransitionId")

  @@index([ProductTransitionId], map: "IX_QueueRecords_ProductTransitionId")
  @@id([Queue, JobId], map: "IX_QueueRecords_Queue_JobId")
}

model Products {
  Id                  String                @id(map: "PK_Products") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ProjectId           Int
  ProductDefinitionId Int
  StoreId             Int?
  StoreLanguageId     Int?
  DateCreated         DateTime?             @default(now()) @db.Timestamp(6)
  DateUpdated         DateTime?             @updatedAt @db.Timestamp(6)
  WorkflowJobId       Int
  WorkflowBuildId     Int
  DateBuilt           DateTime?             @db.Timestamp(6)
  WorkflowPublishId   Int
  DatePublished       DateTime?             @db.Timestamp(6)
  PublishLink         String?
  VersionBuilt        String?
  Properties          String?
  PackageName         String?
  ProductArtifacts    ProductArtifacts[]
  ProductBuilds       ProductBuilds[]
  ProductPublications ProductPublications[]
  ProductTransitions  ProductTransitions[]
  ProductDefinition   ProductDefinitions    @relation(fields: [ProductDefinitionId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Products_ProductDefinitions_ProductDefinitionId")
  Project             Projects              @relation(fields: [ProjectId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Products_Projects_ProjectId")
  StoreLanguage       StoreLanguages?       @relation(fields: [StoreLanguageId], references: [Id], onDelete: Restrict, onUpdate: NoAction, map: "FK_Products_StoreLanguages_StoreLanguageId")
  Store               Stores?               @relation(fields: [StoreId], references: [Id], onDelete: Restrict, onUpdate: NoAction, map: "FK_Products_Stores_StoreId")
  UserTasks           UserTasks[]
  WorkflowInstance    WorkflowInstances?
  ProductUserChanges  ProductUserChanges[]
  SoftwareUpdates     SoftwareUpdates[]

  @@index([ProductDefinitionId], map: "IX_Products_ProductDefinitionId")
  @@index([ProjectId], map: "IX_Products_ProjectId")
  @@index([StoreId], map: "IX_Products_StoreId")
  @@index([StoreLanguageId], map: "IX_Products_StoreLanguageId")
}

model ProjectImports {
  Id              Int               @id(map: "PK_ProjectImports") @default(autoincrement())
  ImportData      String?
  TypeId          Int?
  OwnerId         Int?
  GroupId         Int?
  OrganizationId  Int?
  DateCreated     DateTime?         @default(now()) @db.Timestamp(6)
  DateUpdated     DateTime?         @updatedAt @db.Timestamp(6)
  ApplicationType ApplicationTypes? @relation(fields: [TypeId], references: [Id], onUpdate: NoAction, map: "FK_ProjectImports_ApplicationTypes_TypeId")
  Group           Groups?           @relation(fields: [GroupId], references: [Id], onUpdate: NoAction, map: "FK_ProjectImports_Groups_GroupId")
  Organization    Organizations?    @relation(fields: [OrganizationId], references: [Id], onUpdate: NoAction, map: "FK_ProjectImports_Organizations_OrganizationId")
  Owner           Users?            @relation(fields: [OwnerId], references: [Id], onUpdate: NoAction, map: "FK_ProjectImports_Users_OwnerId")
  Projects        Projects[]

  @@index([GroupId], map: "IX_ProjectImports_GroupId")
  @@index([OrganizationId], map: "IX_ProjectImports_OrganizationId")
  @@index([OwnerId], map: "IX_ProjectImports_OwnerId")
  @@index([TypeId], map: "IX_ProjectImports_TypeId")
}

model Projects {
  Id                      Int              @id(map: "PK_Projects") @default(autoincrement())
  Name                    String?
  TypeId                  Int
  Description             String?
  OwnerId                 Int
  GroupId                 Int
  OrganizationId          Int
  Language                String?
  IsPublic                Boolean?         @default(true)
  DateCreated             DateTime?        @default(now()) @db.Timestamp(6)
  DateUpdated             DateTime?        @updatedAt @db.Timestamp(6)
  DateArchived            DateTime?        @db.Timestamp(6)
  AllowDownloads          Boolean?         @default(true)
  AutoPublishOnRebuild    Boolean?         @default(false)
  RebuildOnSoftwareUpdate Boolean?         @default(false)
  WorkflowProjectId       Int              @default(0)
  WorkflowProjectUrl      String?
  WorkflowAppProjectUrl   String?
  DateActive              DateTime?        @db.Timestamp(6)
  ImportId                Int?
  Authors                 Authors[]
  Products                Products[]
  ApplicationType         ApplicationTypes @relation(fields: [TypeId], references: [Id], onUpdate: NoAction, map: "FK_Projects_ApplicationTypes_TypeId")
  Group                   Groups           @relation(fields: [GroupId], references: [Id], onUpdate: NoAction, map: "FK_Projects_Groups_GroupId")
  Organization            Organizations    @relation(fields: [OrganizationId], references: [Id], onUpdate: NoAction, map: "FK_Projects_Organizations_OrganizationId")
  ProjectImport           ProjectImports?  @relation(fields: [ImportId], references: [Id], onDelete: Restrict, onUpdate: NoAction, map: "FK_Projects_ProjectImports_ImportId")
  Owner                   Users            @relation(fields: [OwnerId], references: [Id], onUpdate: NoAction, map: "FK_Projects_Users_OwnerId")
  Reviewers               Reviewers[]

  @@index([GroupId], map: "IX_Projects_GroupId")
  @@index([ImportId], map: "IX_Projects_ImportId")
  @@index([OrganizationId], map: "IX_Projects_OrganizationId")
  @@index([OwnerId], map: "IX_Projects_OwnerId")
  @@index([TypeId], map: "IX_Projects_TypeId")
}

model Reviewers {
  Id        Int      @id(map: "PK_Reviewers") @default(autoincrement())
  Name      String?
  Email     String?
  ProjectId Int
  Locale    String?
  Project   Projects @relation(fields: [ProjectId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Reviewers_Projects_ProjectId")

  @@index([ProjectId], map: "IX_Reviewers_ProjectId")
}

model StoreLanguages {
  Id          Int        @id(map: "PK_StoreLanguages") @default(autoincrement())
  Name        String?
  Description String?
  StoreTypeId Int
  Products    Products[]
  StoreType   StoreTypes @relation(fields: [StoreTypeId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_StoreLanguages_StoreTypes_StoreTypeId")

  @@index([StoreTypeId], map: "IX_StoreLanguages_StoreTypeId")
}

model StoreTypes {
  Id                  Int                   @id(map: "PK_StoreTypes") @default(autoincrement())
  Name                String?
  Description         String?
  StoreLanguages      StoreLanguages[]
  Stores              Stores[]
  WorkflowDefinitions WorkflowDefinitions[]
}

model Stores {
  Id                 Int                  @id(map: "PK_Stores") @default(autoincrement())
  Name               String?
  Description        String?
  StoreTypeId        Int
  OrganizationStores OrganizationStores[]
  Products           Products[]
  StoreType          StoreTypes           @relation(fields: [StoreTypeId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Stores_StoreTypes_StoreTypeId")

  @@index([StoreTypeId], map: "IX_Stores_StoreTypeId")
}

model SystemStatuses {
  Id                        Int       @id(map: "PK_SystemStatuses") @default(autoincrement())
  BuildEngineUrl            String?
  BuildEngineApiAccessToken String?
  SystemAvailable           Boolean
  DateCreated               DateTime? @default(now()) @db.Timestamp(6)
  DateUpdated               DateTime? @updatedAt @db.Timestamp(6)
}

model SystemVersions {
  BuildEngineUrl    String // weak link to SystemStatuses table
  ApplicationTypeId Int
  Version           String?          @default("13.2") // defaulting to 13.2 because this is what BuildEngine supports at this time
  DateCreated       DateTime?        @default(now()) @db.Timestamp(6)
  DateUpdated       DateTime?        @updatedAt @db.Timestamp(6)
  ImageHash         String?
  ApplicationType   ApplicationTypes @relation(fields: [ApplicationTypeId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_SystemVersions_ApplicationTypes_ ApplicationTypeId")

  @@id([BuildEngineUrl, ApplicationTypeId], map: "PK_SystemVersions_BuildEngineUrl_ApplicationTypeId")
}

model SoftwareUpdates {
  Id                Int              @id(map: "PK_SoftwareUpdates") @default(autoincrement())
  InitiatedById     Int
  Comment           String
  Paused            Boolean          @default(false)
  DateCreated       DateTime?        @default(now()) @db.Timestamp(6)
  DateUpdated       DateTime?        @updatedAt @db.Timestamp(6)
  DateCompleted     DateTime?        @db.Timestamp(6)
  // Version information
  BuildEngineUrl    String
  ApplicationTypeId Int
  Version           String
  InitiatedBy       Users            @relation(fields: [InitiatedById], references: [Id])
  ApplicationType   ApplicationTypes @relation(fields: [ApplicationTypeId], references: [Id])
  // Implicit m-n table. Org and project reachable through this relation
  Products          Products[]
}

model UserRoles {
  // ISSUE: #1102 composite keys?
  Id             Int           @id(map: "PK_UserRoles") @default(autoincrement())
  UserId         Int
  RoleId         Int
  OrganizationId Int
  Organization   Organizations @relation(fields: [OrganizationId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_UserRoles_Organizations_OrganizationId")
  User           Users         @relation(fields: [UserId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_UserRoles_Users_UserId")

  @@index([OrganizationId], map: "IX_UserRoles_OrganizationId")
  @@index([RoleId], map: "IX_UserRoles_RoleId")
  @@index([UserId], map: "IX_UserRoles_UserId")
}

model UserTasks {
  Id           Int       @id(map: "PK_UserTasks") @default(autoincrement())
  UserId       Int
  ProductId    String    @db.Uuid
  ActivityName String?
  Status       String?
  Comment      String?
  DateCreated  DateTime? @default(now()) @db.Timestamp(6)
  DateUpdated  DateTime? @updatedAt @db.Timestamp(6)
  Role         Int       @default(3) // AppBuilder (i.e. the Project Owner)
  Product      Products  @relation(fields: [ProductId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_UserTasks_Products_ProductId")
  User         Users     @relation(fields: [UserId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_UserTasks_Users_UserId")

  @@index([ProductId], map: "IX_UserTasks_ProductId")
  @@index([UserId], map: "IX_UserTasks_UserId")
}

model Users {
  Id                            Int                             @id(map: "PK_Users") @default(autoincrement())
  Name                          String?
  GivenName                     String?
  FamilyName                    String?
  Email                         String?
  Phone                         String?
  Timezone                      String?
  Locale                        String?
  IsLocked                      Boolean
  ExternalId                    String?
  ProfileVisibility             Int                             @default(1)
  EmailNotification             Boolean?                        @default(true)
  DateCreated                   DateTime?                       @default(now()) @db.Timestamp(6)
  DateUpdated                   DateTime?                       @updatedAt @db.Timestamp(6)
  Authors                       Authors[]
  GroupMemberships              GroupMemberships[]
  OrganizationMembershipInvites OrganizationMembershipInvites[]
  OrganizationMemberships       OrganizationMemberships[]
  ProjectImports                ProjectImports[]
  Projects                      Projects[]
  UserRoles                     UserRoles[]
  UserTasks                     UserTasks[]
  ProductTransitions            ProductTransitions[]
  SoftwareUpdates               SoftwareUpdates[]
}

model WorkflowDefinitions {
  Id                          Int                  @id(map: "PK_WorkflowDefinitions") @default(autoincrement())
  Name                        String?
  Enabled                     Boolean
  Description                 String?
  StoreTypeId                 Int?
  Type                        Int                  @default(1)
  Properties                  String?
  RebuildProductDefinitions   ProductDefinitions[] @relation("ProductDefinitions_RebuildWorkflowIdToWorkflowDefinitions")
  RepublishProductDefinitions ProductDefinitions[] @relation("ProductDefinitions_RepublishWorkflowIdToWorkflowDefinitions")
  ProductDefinitions          ProductDefinitions[] @relation("ProductDefinitions_WorkflowIdToWorkflowDefinitions")
  StoreType                   StoreTypes?          @relation(fields: [StoreTypeId], references: [Id], onDelete: Restrict, onUpdate: NoAction, map: "FK_WorkflowDefinitions_StoreTypes_StoreTypeId")
  ProductType                 Int                  @default(0)
  WorkflowOptions             Int[]                @default([])
  WorkflowInstances           WorkflowInstances[]

  @@index([StoreTypeId], map: "IX_WorkflowDefinitions_StoreTypeId")
}

model ProductUserChanges {
  Id            Int       @id(map: "PK_ProductUserChanges") @default(autoincrement())
  ProductId     String    @db.Uuid
  Email         String?
  Change        String?
  DateCreated   DateTime? @default(now()) @db.Timestamp(6)
  DateUpdated   DateTime? @updatedAt @db.Timestamp(6)
  DateCompleted DateTime? @db.Timestamp(6)
  // there isn't a good way to fix this warning without breaking the migration...
  Product       Products? @relation(fields: [ProductId], references: [Id], onDelete: SetNull, onUpdate: NoAction, map: "FK_ProductUserChanges_Products_ProductId")

  @@index([ProductId], map: "IX_ProductUserChanges_ProductId")
}

model WorkflowInstances {
  // ISSUE: #1102 composite keys?
  Id                   Int                 @id(map: "PK_WorkflowInstances") @default(autoincrement())
  State                String
  Context              String
  WorkflowDefinitionId Int
  ProductId            String              @unique @db.Uuid
  DateCreated          DateTime?           @default(now()) @db.Timestamp
  DateUpdated          DateTime?           @updatedAt @db.Timestamp
  Product              Products            @relation(fields: [ProductId], references: [Id], onDelete: NoAction, onUpdate: NoAction, map: "FK_WorkflowInstances_Products_ProductId")
  WorkflowDefinition   WorkflowDefinitions @relation(fields: [WorkflowDefinitionId], references: [Id], onDelete: NoAction, onUpdate: NoAction, map: "FK_WorkflowInstances_WorkflowDefinitions_WorkflowDefinitionId")
}
