env:
  - DOCKER_COMPOSE_VERSION=1.17.0 MOZ_HEADLESS=1


jobs:
  include:
    - stage: "Tests"
      name: "Frontend Tests"
      addons:
        chrome: stable

      language: node_js
      node_js: "8"
      cache:
        yarn: true
        directories:
          - source/SIL.AppBuilder.Portal.Frontend/node_modules

      script: ./run yarn && ./run yarn lint && ./run yarn test:ci

    - stage: "Tests"
      name: "Backend Tests"
      language: generic
      sudo: required
      services:
        - docker
      addons:
        apt:
          packages:
            - docker-ce
      before_install:
        # pip 10 is broken, I guess
        - >
          time (
            sudo pip install --upgrade --force-reinstall pip==9.0.3
            sudo pip install -U docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          )

      script: 
        - echo "building docker containers..."
        - time ( ./run ci:build > /dev/null 2>&1 )
        - echo "docker containers built!"
        - echo "Running the backend commands..."
        - ( time ./run ci:api )

    - stage: "Deploy"
      name: "Build and Push Docker Images"
      if: branch = master
      before_deploy:
        # must cleanup root owned files
        - time ( sudo ./run clean:api )
      deploy:
        provider: script
        script: time ./scripts/deploy-travis.sh $TRAVIS_COMMIT latest
        on:
          branch: master
