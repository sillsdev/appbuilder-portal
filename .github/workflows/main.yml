name: Scriptoria v2 Test and Deploy

on:
  push:
    branches:
      - feature/svelte
      - develop
      - master
  pull_request:
    branches:
      - feature/svelte
      - develop
      - master
  workflow_dispatch:

jobs:
  # Install dependencies once and cache for other jobs
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Get environment info
        run: |
          echo Node version
          node --version
          npm --version
          echo
          echo Docker version
          docker --version
          echo
          echo Environment variables
          env

      - name: Restore node_modules cache
        id: restore-cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json', 'src/lib/prisma/schema.prisma') }}

      - name: Install dependencies
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: |
          echo "Installing dependencies..."
          npm ci

      - name: Cache node_modules
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json', 'src/lib/prisma/schema.prisma') }}

  # Type checking and linting
  typecheck-lint:
    runs-on: ubuntu-latest
    needs: setup
    env:
      BUILDENGINE_TOKEN: ${{ secrets.BUILD_ENGINE_TOKEN }}
      AUTH0_SECRET: ${{ secrets.AUTH0_SECRET }}
      AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
      AUTH0_CLIENT_ID: ${{ vars.AUTH0_CLIENT_ID }}
      AUTH0_DOMAIN: ${{ vars.AUTH0_DOMAIN }}
      AUTH0_CONNECTION: ${{ vars.AUTH0_CONNECTION }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: 24

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json', 'src/lib/prisma/schema.prisma') }}

      - name: Compile paraglide messages and run svelte-check
        run: |
          echo "Compiling paraglide messages..."
          npx @inlang/paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide
          echo "Running svelte-check..."
          npm run check

      - name: Run lint
        run: |
          echo "Running lint..."
          npm run lint

  # Build and run a smoke test
  build-and-test:
    runs-on: ubuntu-latest
    needs: setup
    env:
      CI: true
      BUILDENGINE_TOKEN: ${{ secrets.BUILD_ENGINE_TOKEN }}
      AUTH0_SECRET: ${{ secrets.AUTH0_SECRET }}
      AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
      AUTH0_CLIENT_ID: ${{ vars.AUTH0_CLIENT_ID }}
      AUTH0_DOMAIN: ${{ vars.AUTH0_DOMAIN }}
      AUTH0_CONNECTION: ${{ vars.AUTH0_CONNECTION }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: 24

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json', 'src/lib/prisma/schema.prisma') }}

      - name: Setup Mock Build-Engine
        run: |
          # This step may need to be reordered.
          # I have no idea how much actually needs to be done here or if this should be multiple steps.
          # Just adding this here for now so there is a diff so I can open a draft PR for all to work on.
          # - Aidan

      - name: Build, Install Playwright dependencies, and seed database
        run: |
          echo "Building .env file..."
          echo "AUTH0_CLIENT_ID=" > .env
          echo "AUTH0_CLIENT_SECRET=" >> .env
          echo "AUTH0_DOMAIN=" >> .env
          echo "AUTH0_CONNECTION=" >> .env
          echo "AUTH0_SECRET=" >> .env
          echo "Building the docker project..."
          mkdir -p command-output
          (./run ci build > command-output/build-output.txt 2>&1 || echo $? > command-output/build-exit-code.txt) &
          echo "Installing Playwright dependencies..."
          (npx playwright install --with-deps > command-output/playwright-output.txt 2>&1 || echo $? > command-output/playwright-exit-code.txt) &
          echo "Beginning pull of images"
          ./run ci pull valkey > /dev/null &
          echo "Starting database..."
          ./run ci up -d db
          sleep 1
          echo "Seeding the database..."
          npx prisma migrate reset -f --skip-seed --skip-generate && npx prisma db seed
          echo "Waiting for build and Playwright installation to finish..."
          wait
          if [ -f command-output/build-exit-code.txt ]; then
            BUILD_EXIT_CODE=$(cat command-output/build-exit-code.txt)
            echo "Build failed with exit code $BUILD_EXIT_CODE"
            cat command-output/build-output.txt
            exit $BUILD_EXIT_CODE
          fi
          if [ -f command-output/playwright-exit-code.txt ]; then
            PLAYWRIGHT_EXIT_CODE=$(cat command-output/playwright-exit-code.txt)
            echo "Playwright installation failed with exit code $PLAYWRIGHT_EXIT_CODE"
            cat command-output/playwright-output.txt
            exit $PLAYWRIGHT_EXIT_CODE
          fi
          echo "Build and Playwright installation completed."
        env:
          DATABASE_URL: "postgresql://db-user:1234@localhost:5432/development?schema=public"

      - name: Start docker-compose services
        run: |
          echo "Starting docker-compose services..."
          ./run ci up -d

      - name: Run tests
        run: |
          # Is the port open
          sleep 1
          nc -zv localhost 6173 || {
            echo "Port 6173 is not open"
            ./run ci logs portal
            exit 1
          }
          npx svelte-kit sync
          echo "Running tests..."
          npm run test
        env:
          CI_PASSWORD: ${{ secrets.CI_PASSWORD }}
          CI_EMAIL: ci@scriptoria.io
          AWS_EMAIL_ACCESS_KEY_ID: ${{ secrets.AWS_EMAIL_ACCESS_KEY_ID }}
          AWS_EMAIL_SECRET_ACCESS_KEY: ${{ secrets.AWS_EMAIL_SECRET_ACCESS_KEY }}
          MAIL_SENDER: "AmazonSES"
          ADMIN_NAME: "Scriptoria Staging"
          ADMIN_EMAIL: "noreply@scriptoria.io"
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: playwright/test-results

  # Deploy to ECR and ECS
  deploy-to-ecr:
    runs-on: ubuntu-latest
    needs: [build-and-test, typecheck-lint]
    if: ${{ success() && ((github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master') && github.event_name != 'pull_request' ) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup node
        uses: actions/setup-node@v5
        with:
          node-version: 24

      - name: Configure AWS credentials (SIL)
        id: aws_sil
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.DEPLOY__AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEPLOY__AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.DEPLOY__AWS_DEFAULT_REGION }}

      - name: Login to AWS ECR (SIL)
        id: ecr_sil
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ secrets.DEPLOY__AWS_ECR_ACCOUNT }}

      - name: Build deployment target variables
        id: vars
        run: |
          echo "Setting up deployment variables..."
          echo "IMAGE_URL=${{ secrets.DEPLOY__AWS_ECR_ACCOUNT }}.dkr.ecr.${{ secrets.DEPLOY__AWS_DEFAULT_REGION }}.amazonaws.com/appbuilder-portal-origin" >> $GITHUB_OUTPUT
          echo "OTEL_URL=${{ secrets.DEPLOY__AWS_ECR_ACCOUNT }}.dkr.ecr.${{ secrets.DEPLOY__AWS_DEFAULT_REGION }}.amazonaws.com/otel-collector" >> $GITHUB_OUTPUT
          [[ "${{ github.ref }}" == "refs/heads/master" ]] && echo "DEPLOY_LEVEL=production" >> $GITHUB_OUTPUT || echo "DEPLOY_LEVEL=staging" >> $GITHUB_OUTPUT
          [[ "${{ github.ref }}" == "refs/heads/master" ]] && echo "ECS_CLUSTER=scriptoria-prd" >> $GITHUB_OUTPUT || echo "ECS_CLUSTER=scriptoria-stg" >> $GITHUB_OUTPUT

      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          docker build -t scriptoria-portal:${{ github.sha }} .
          docker build -t scriptoria-otel:${{ github.sha }} -f Dockerfile.otel .
          echo "Docker images built successfully."
          docker tag scriptoria-portal:${{ github.sha }} ${{ steps.vars.outputs.IMAGE_URL }}:${{ steps.vars.outputs.DEPLOY_LEVEL }}
          docker tag scriptoria-portal:${{ github.sha }} ${{ steps.vars.outputs.IMAGE_URL }}:${{ github.sha }}
          docker tag scriptoria-otel:${{ github.sha }} ${{ steps.vars.outputs.OTEL_URL }}:${{ steps.vars.outputs.DEPLOY_LEVEL }}
          docker tag scriptoria-otel:${{ github.sha }} ${{ steps.vars.outputs.OTEL_URL }}:${{ github.sha }}
          echo "Docker images tagged as ${{ steps.vars.outputs.DEPLOY_LEVEL }} and ${{ github.sha }}"

      - name: Push Docker image to ECR
        run: |
          echo "Pushing Docker image to ECR..."
          docker push ${{ steps.vars.outputs.IMAGE_URL }}:${{ steps.vars.outputs.DEPLOY_LEVEL }}
          docker push ${{ steps.vars.outputs.IMAGE_URL }}:${{ github.sha }}
          docker push ${{ steps.vars.outputs.OTEL_URL }}:${{ steps.vars.outputs.DEPLOY_LEVEL }}
          docker push ${{ steps.vars.outputs.OTEL_URL }}:${{ github.sha }}
          echo "Docker images pushed successfully to ${{ steps.vars.outputs.IMAGE_URL }}"

      - name: Deploy to ECS
        run: |
          echo "Installing ecs-deploy script..."
          mkdir -p $HOME/.local/bin
          curl -o $HOME/.local/bin/ecs-deploy https://raw.githubusercontent.com/silinternational/ecs-deploy/master/ecs-deploy
          chmod +x $HOME/.local/bin/ecs-deploy
          echo "Deploying ${{ github.sha }} to ${{ steps.vars.outputs.ECS_CLUSTER }}..."
          # Deploy the ECS cluster with service name 'portal', setting all images to the latest tag
          ecs-deploy -c ${{ steps.vars.outputs.ECS_CLUSTER }} -n portal -i ignore -to ${{ github.sha }} --max-definitions 20 --timeout 600
          echo "Deployment initiated successfully."
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DEPLOY__AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DEPLOY__AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.DEPLOY__AWS_DEFAULT_REGION }}
