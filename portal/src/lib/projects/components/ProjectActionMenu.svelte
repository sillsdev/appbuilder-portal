<script lang="ts">
  import { page } from '$app/state';
  import BlockIfJobsUnavailable from '$lib/components/BlockIfJobsUnavailable.svelte';
  import Dropdown from '$lib/components/Dropdown.svelte';
  import IconContainer from '$lib/components/IconContainer.svelte';
  import { m } from '$lib/paraglide/messages';
  import type { ProjectActionSchema, ProjectForAction } from '$lib/projects';
  import { canArchive, canClaimProject, canReactivate } from '$lib/projects';
  import { toast } from '$lib/utils';
  import type { Infer, SuperValidated } from 'sveltekit-superforms';
  import { superForm } from 'sveltekit-superforms';

  interface Props {
    data: SuperValidated<Infer<ProjectActionSchema>>;
    project: ProjectForAction;
    /** allow actions other than reactivation */
    allowActions?: boolean;
    allowReactivate?: boolean;
    userGroups: number[];
    endpoint?: string;
    orgId: number;
  }

  let {
    data,
    project,
    allowActions = true,
    allowReactivate = true,
    userGroups,
    endpoint = 'projectAction',
    orgId
  }: Props = $props();

  const { form, enhance, submit } = superForm(data, {
    dataType: 'json',
    invalidateAll: true,
    warnings: { duplicateId: false },
    onChange: (event) => {
      if (event.paths.includes('operation') && $form.operation) {
        submit();
      }
    },
    onError: ({ result }) => {
      if (result.status === 503) {
        toast('error', m.system_unavailable());
      }
    }
  });

  function canClaimOwnership(project: Omit<ProjectForAction, 'Id' | 'Name'>): boolean {
    return (
      project.OwnerId !== page.data.session?.user.userId &&
      canClaimProject(page.data.session, project.OwnerId, orgId, project.GroupId, userGroups)
    );
  }
</script>

<Dropdown
  dropdownClasses="dropdown-bottom dropdown-end"
  labelClasses="max-h-fit min-h-fit p-1 inline"
  contentClasses="p-1 min-w-36 w-auto"
  onclick={() => {
    $form.projectId = project.Id;
  }}
>
  {#snippet label()}
    <IconContainer icon="charm:menu-kebab" width={20} />
  {/snippet}
  {#snippet content()}
    <form method="POST" action="?/{endpoint}" use:enhance>
      <input type="hidden" name="projectId" value={project.Id} />
      <ul class="menu menu-compact overflow-hidden rounded-md">
        {#if allowActions && canArchive(project, page.data.session, parseInt(page.params.id))}
          <li class="w-full rounded-none">
            <BlockIfJobsUnavailable className="text-nowrap">
              {#snippet altContent()}
                {m.common_archive()}
              {/snippet}
              <label class="text-nowrap">
                {@render altContent()}
                <input class="hidden" type="radio" bind:group={$form.operation} value="archive" />
              </label>
            </BlockIfJobsUnavailable>
          </li>
        {/if}
        {#if allowReactivate && canReactivate(project, page.data.session, parseInt(page.params.id))}
          <li class="w-full rounded-none">
            <BlockIfJobsUnavailable className="text-nowrap">
              {#snippet altContent()}
                {m.common_reactivate()}
              {/snippet}
              <label class="text-nowrap">
                {@render altContent()}
                <input
                  class="hidden"
                  type="radio"
                  bind:group={$form.operation}
                  value="reactivate"
                />
              </label>
            </BlockIfJobsUnavailable>
          </li>
        {/if}
        {#if canClaimOwnership(project)}
          <li class="w-full rounded-none">
            <BlockIfJobsUnavailable className="text-nowrap">
              {#snippet altContent()}
                {m.project_claimOwnership()}
              {/snippet}
              <label class="text-nowrap">
                {@render altContent()}
                <input class="hidden" type="radio" bind:group={$form.operation} value="claim" />
              </label>
            </BlockIfJobsUnavailable>
          </li>
        {/if}
      </ul>
    </form>
  {/snippet}
</Dropdown>
