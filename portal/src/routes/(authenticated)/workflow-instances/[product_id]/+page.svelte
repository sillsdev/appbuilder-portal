<script lang="ts">
  import { browser } from '$app/environment';
  import Dropdown from '$lib/components/Dropdown.svelte';
  import IconContainer from '$lib/components/IconContainer.svelte';
  import { m } from '$lib/paraglide/messages';
  import { localizeHref } from '$lib/paraglide/runtime';
  import ProductDetails, {
    showProductDetails
  } from '$lib/products/components/ProductDetails.svelte';
  import { Springy } from '$lib/springyGraph.js';
  import { toast } from '$lib/utils';
  import { onMount } from 'svelte';
  import { superForm } from 'sveltekit-superforms';
  import { Anchor, Node, Svelvet } from 'svelvet';
  import type { PageData } from './$types';

  interface Props {
    data: PageData;
  }

  let { data }: Props = $props();

  let active = $state(data.form.data.state);

  const { form, enhance } = superForm(data.form, {
    onUpdate: ({ form }) => {
      active = form.data.state;
    },
    onError: ({ result }) => {
      if (result.status === 503) {
        toast('error', m.system_unavailable());
      }
    },
    invalidateAll: false,
    resetForm: false
  });

  let positions: Record<string, Springy.Physics.Vector> = $state(
    Object.fromEntries(data.machine.map((s) => [s.label, new Springy.Physics.Vector(0.0, 0.0)]))
  );

  let ready = $state(false);

  onMount(() => {
    const graph = new Springy.Graph();
    graph.loadJSON({
      nodes: data.machine.map((s) => s.label),
      edges: data.machine.flatMap((s) => {
        return s.connections.map((c) => [s.label, c.target]);
      })
    });
    const bounds = Math.ceil(Math.sqrt(graph.nodes.length));
    graph.addNodeData('Start', {
      label: 'Start',
      static: new Springy.Physics.Vector(-bounds, -bounds)
    });
    graph.addNodeData('Published', {
      label: 'Published',
      static: new Springy.Physics.Vector(bounds, bounds)
    });
    if ('Terminated' in graph.nodeSet) {
      graph.addNodeData('Terminated', {
        label: 'Terminated',
        static: new Springy.Physics.Vector(bounds, -bounds)
      });
    }
    graph.addNodeData('Synchronize Data', {
      label: 'Synchronize Data',
      static: new Springy.Physics.Vector(-bounds, bounds)
    });

    const layout = new Springy.ForceDirected(graph, 400.0, 400.0, 0.5, 0.00001);

    const renderer = new Springy.Renderer(
      layout,
      () => {}, // clear
      () => {}, // drawEdge
      (node: Springy.Node, position: Springy.Physics.Vector) => {
        // drawNode
        positions[node.id] = position;
      },
      () => {}, // onRenderStop
      () => {}, // onRenderStart
      () => {
        // If we show it this early, there will be practically no loading spinner
        // But there will also be much more movement when rendering
        // This should probably be discussed.
        ready = true;
        // onRenderFrame
        // begin showing earlier, still simulating, just less loading time
        if (layout.totalEnergy() < 0.5) {
          ready = true;
        }
      }
    );
    renderer.start();
  });

  // Note: At the moment, the site always follows prefered color scheme
  // If at some point in the future a manual toggle is added, this will need to be changed
  let isDarkMode: boolean = $state(
    browser ? window.matchMedia('(prefers-color-scheme: dark)').matches : false
  );
  browser &&
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
      isDarkMode = event.matches;
    });
</script>

<div class="h-full">
  <div class="navbar">
    <div class="breadcrumbs text-sm grow">
      <ul>
        <li>
          <a
            class="link"
            href={localizeHref(`/projects/org/${data.product?.Project.Organization.Id}`)}
          >
            {data.product?.Project.Organization.Name}
          </a>
        </li>
        <li>
          <a class="link" href={localizeHref(`/projects/${data.product?.Project.Id}`)}>
            {data.product?.Project.Name}
          </a>
        </li>
        <li>
          <a class="link" href={localizeHref('/workflow-instances')}>
            {m.workflowInstances_title()}
          </a>
        </li>
        <li>
          {data.product?.ProductDefinition.Name}
        </li>
      </ul>
    </div>
    <span class="navbar-end w-auto">
      <Dropdown labelClasses="px-1" contentClasses="top-12 right-0 p-1 min-w-36 w-auto">
        {#snippet label()}
          <IconContainer icon="charm:menu-kebab" width="20" />
        {/snippet}
        {#snippet content()}
          <ul class="menu menu-compact overflow-hidden rounded-md">
            <li class="w-full rounded-none">
              <button class="text-nowrap" onclick={() => showProductDetails(data.product.Id)}>
                {m.products_details()}
              </button>
            </li>
            <li class="w-full rounded-none" class:opacity-30={!data.jobsAvailable}>
              <form method="POST" use:enhance>
                <input type="hidden" name="state" bind:value={$form.state} />
                <input
                  type="submit"
                  class="text-nowrap"
                  class:hidden={!data.jobsAvailable}
                  value={m.workflowInstances_jump({ state: $form.state })}
                />
                {#if !data.jobsAvailable}
                  <button
                    type="button"
                    class="text-nowrap cursor-not-allowed"
                    onclick={() => toast('warning', m.system_unavailable())}
                  >
                    {m.workflowInstances_jump({ state: $form.state })}
                  </button>
                {/if}
              </form>
            </li>
          </ul>
        {/snippet}
      </Dropdown>
    </span>
  </div>
  <ProductDetails product={data.product} transitions={data.transitions} />
  <div id="svelvet-wrapper">
    {#if ready}
      <Svelvet
        minimap
        controls
        fitView
        edgeStyle="straight"
        theme={isDarkMode ? 'dark' : 'light'}
        translation={{ x: 0, y: 0 }}
        endStyles={[null, 'arrow']}
      >
        {#each data.machine as state, i}
          <Node
            id={'N-' + state.id}
            dimensions={{ width: 200, height: 100 }}
            position={positions[state.label].translateToScreenSpace(
              new Springy.Physics.Vector(0, 0),
              new Springy.Physics.Vector(150, 100)
            )}
            dynamic={true}
            editable={false}
          >
            <!-- svelte-ignore a11y_no_static_element_interactions -->
            <!-- svelte-ignore a11y_click_events_have_key_events -->
            <svg
              class="rect"
              class:active={active === state.label}
              class:start={state.start}
              class:final={state.final}
              class:action={state.action}
              onclick={() => {
                $form.state = state.label;
              }}
            >
              <rect
                width="100%"
                height="100%"
                rx="10"
                ry="10"
                class:selected={$form.state === state.label}
              />
              <text text-anchor="middle" font-size={15} x="50%" y="60%">
                {state.label}
              </text>
            </svg>
            {#each state.connections as conn}
              <Anchor connections={[conn.id]} edgeLabel={conn.label} output invisible locked />
            {/each}
            {#each { length: state.inCount } as c}
              <Anchor input invisible locked />
            {/each}
          </Node>
        {/each}
      </Svelvet>
    {:else}
      <span class="loading loading-spinner loading-lg"></span>
    {/if}
  </div>
</div>

<style>
  :global(.svelvet-node) {
    box-shadow: none !important;
  }
  .rect {
    fill: var(--color-neutral);
    height: 100%;
    width: 100%;
    stroke-width: 7px;
  }
  .rect text {
    align-items: center;
    font-weight: bold;
    fill: var(--color-neutral-content);
  }
  .active {
    fill: var(--color-warning);
  }
  .start {
    fill: var(--color-success);
  }
  .final {
    fill: var(--color-info);
  }
  :is(:global(.active, .final, .start)) text {
    fill: var(--color-primary-content);
  }
  .selected {
    stroke: var(--color-warning);
  }
  .active > .selected {
    stroke: var(--color-neutral-content);
  }
  .action {
    fill: var(--color-neutral);
    opacity: 50%;
  }
  .action text {
    fill: var(--color-neutral-content);
    stroke: none;
  }
  .navbar {
    height: 10%;
  }
  #svelvet-wrapper {
    height: 90%;
  }
  .loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
  }
</style>
